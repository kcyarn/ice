<!DOCTYPE HTML>
<html>

<head>
	<link rel="stylesheet" href="demo.css" type="text/css" media="screen" />

</head>

<body>
	<div class="container">

		<h1>Ice Demo</h1>

		<p>
			Ice is a track changes implementation, built in javascript, for anything that is contenteditable on the web. The following are demos of Ice in action. You can check out the original code on <a href="https://github.com/NYTimes/ice">github</a>.
			<a href="https://github.com/kcyarn/ice">This</a> version of ICE uses JQuery 2.1.4, which only supports IE 8+. It also removes <b>all</b> browser detection and updates rangy from 1.2.3 to 1.3.0. It is untested in all browsers other than Chrome!
		</p>
		<h3>Contenteditable</h3>
		<p>
			With some text editing management of your own, Ice can be initialized on any element that is contenteditable. The following is a makeshift editor, made out of a `div` element container and some `p` root blocks. The editor buttons use Ice's API to change
			the user being tracked and toggle the visibility of changes.
		</p>

		<div class="editor">
			<div class="control">
				<strong>Track Changes:</strong>
				<button id="track_changes_off">Track Changes Off</button>
				<button id="show_hide_changes">Hide Changes</button>
				<button id="accept_all">Accept All</button>
				<button id="reject_all">Reject All</button>
				<button id="accept_this">Accept This</button>
				<button id="reject_this">Reject This</button>
				<button id="highlight_this">Highlight This</button>
				<button id="highlight_remove_this">Remove This Highlight</button>
				<button id="highlight_remove_all">Remove All Hightlights</button>
				<button id="comment_this">Add Comment</button>
				<button id="comment_delete">Delete Comment</button>
				<button id="comment_delete_all">Delete All Comments</button>
			  <button id="critic_markup">Turn Critic Markup On</button>
			</div>
			<div>
				<div class="control">
					<strong>Style:</strong>
					<button onclick="document.execCommand('bold', null, false);">
						<strong>B</strong>
					</button>
					<button onclick="document.execCommand('italic', null, false);">
						<em>i</em>
					</button>
				</div>
				<div class="control">
					<strong>Indent:</strong>
					<button onclick="document.execCommand('formatBlock', null, '<h2>');">H</button>
					<button onclick="document.execCommand('formatBlock', null, '<p>');">p</button>
					<button onclick="document.execCommand('formatBlock', null, '<blockquote>');">&quot;</button>
				</div>
				<div class="control">
					<strong>List:</strong>
					<button onclick="document.execCommand('indent', null, false);">&gt;</button>
					<button onclick="document.execCommand('outdent', null, false);">&lt;</button>
				</div>

				<div class="control">
					<strong>List:</strong>
					<button onclick="document.execCommand('InsertUnorderedList', null, false);">UL</button>
					<button onclick="document.execCommand('InsertOrderedList', null, false);">OL</button>
				</div>
				<div class="control">
					<strong>Insert:</strong>
					<button onclick="insertSampleImage();">Sample image</button>
				</div>
			</div>

			<div id="content">
				<div id="text-wrapper">
					<div id="textbody">
						<p>
							<strong>Among the Wealthiest 1 Percent, Many Variations</strong>
							<br/>By SHAILA DEWAN and ROBERT GEBELOFF</p>


						<p>
							<del class="del cts-1" data-cid="2" data-userid="jblank@mail.com" data-username="Jerri Blank" data-time="1326764311895" title="Deleted by Jerri Blank - 01/16/2012 8:38pm">Brooklyn</del>
							<ins class="ins cts-1" data-cid="3" data-userid="jblank@mail.com" data-username="Jerri Blank" data-time="1326764319303" title="Inserted by Jerri Blank - 01/16/2012 8:38pm">Kings Point</ins>, N.Y. &mdash; Adam Katz is
							happy to talk to reporters when he is promoting his business, a charter flight company based on Long Island called Talon Air. <comment class="comment cts4" data-cid="2" data-userid="jblank@mail.com" data-username="Jerri Blank"
							data-time="1326764311895">This is a comment by Jerri Blank.</comment></p>

						<ul>
							<li><a href="http://www.nytimes.com/packages/html/newsgraphics/2012/0115-one-percent-occupations/index.html?ref=business">The Top 1%</a></li>
							<li><a href="http://www.nytimes.com/interactive/2012/01/15/business/one-percent-map.html?ref=business">What Percent Are You?</a></li>
						</ul>

						<p>But when the subject was his position as one of America's top earners, he
							<del class="del cts-1" data-cid="23" data-userid="jblank@mail.com" data-username="Jerri Blank" data-time="1326765043953" title="Deleted by Jerri Blank - 01/16/2012 8:50pm">hesitated</del>
							<ins class="ins cts-1" data-cid="24" data-userid="jblank@mail.com" data-username="Jerri Blank" data-time="1326765049283" title="Inserted by Jerri Blank - 01/16/2012 8:50pm">balked</ins>. Seated at a desk fashioned from a jet fuel cell
							<ins title="Inserted by Geoffrey Jellineck - 01/16/2012 8:42pm" data-time="1326764560331" data-username="Geoffrey Jellineck" data-userid="gjell@mail.com" data-cid="20" class="ins cts-3">, wearing a button-down shirt with the company logo,</ins> he considered the public relations benefits and found them lacking: "It's not very popular to be in the 1 percent these days, is it?"</p>

						<p>
							<img src="http://graphics8.nytimes.com/images/2012/01/15/business/ONEPERCENT/ONEPERCENT-popup.jpg" width="540" />
						</p>


						<p>
							<ins class="ins cts-2" data-cid="14" data-userid="chuck@mail.com" data-username="Chuck Noblet" data-time="1326764402035" title="Inserted by Chuck Noblet - 01/16/2012 8:40pm">A few months ago, Mr. Katz was just a successful businessman with
								<del class="del cts-3" data-cid="15" data-userid="gjell@mail.com" data-username="Geoffrey Jellineck" data-time="1326764492624" title="Deleted by Geoffrey Jellineck - 01/16/2012 8:41pm">four</del>
								<ins class="ins cts-3" data-cid="16" data-userid="gjell@mail.com" data-username="Geoffrey Jellineck" data-time="1326764495239" title="Inserted by Geoffrey Jellineck - 01/16/2012 8:41pm">five</ins> children, an $8 million home, a family real estate company in Manhattan and his passion, 10-year-old Talon Air.</ins>
						</p>

						<p>Now, the colossal gap between the very rich and everyone else
							<ins title="Inserted by Geoffrey Jellineck - 01/16/2012 8:46pm" data-time="1326764809499" data-username="Geoffrey Jellineck" data-userid="gjell@mail.com" data-cid="22" class="ins cts-3">&mdash; the 1 percent versus the 99 percent &mdash; </ins>has become a rallying point in this election season. As President Obama positions himself as a defender of the middle class, and Mitt Romney, the wealthiest of the Republican presidential
							candidates, decries such talk as "the bitter politics of envy," Mr. Katz has found himself on the wrong end of a new paradigm.</p>
						<p>
							<ins class="ins cts-1" data-cid="30" data-userid="jblank@mail.com" data-username="Jerri Blank" data-time="1326765098946" title="Inserted by Jerri Blank - 01/16/2012 8:51pm">As a member of the 1 percent, he is part of a club whose name conjures images of Wall Street bosses who are chauffeured from manse to Manhattan and fat cats who have armies of lobbyists at the ready.</ins>
						</p>
						<p>But in reality it is a far larger and more varied group, one that includes podiatrists and actuaries, executives and entrepreneurs, the self-made and the silver spoon set. They are clustered not just in New York and Los Angeles, but also in Denver
							and Dallas. The range of wealth in the 1 percent is vast &mdash; from households that bring in $380,000 a year, according to census data, up to billionaires like Warren E. Buffett and Bill Gates.</p>
						<p>The top 1 percent of earners in a given year receives <a title="Related data from the Tax Policy Center." href="http://www.taxpolicycenter.org/numbers/displayatab.cfm?DocID=2972">just under a fifth</a> of the country's pretax income, <a title="A Congressional Budget Office report."
							href="http://www.cbo.gov/publications/collections/tax/2010/pre-tax_income_shares.pdf">about double their share</a> 30 years ago. They pay just over a fourth of all federal taxes, according to the Tax Policy Center. In 2007, they accounted for about
							30 percent of philanthropic giving, according to Federal Reserve data. They received 22 percent of their income from capital gains, compared with 2 percent for everybody else.</p>
						<p>
							<ins class="ins cts-3" data-cid="21" data-userid="gjell@mail.com" data-username="Geoffrey Jellineck" data-time="1326764626633" title="Inserted by Geoffrey Jellineck - 01/16/2012 8:43pm">Still, they are not necessarily the idle rich. Mr. Katz, who sometimes commutes by amphibious plane and sometimes carries luggage for Talon Air passengers, likes to say he works "26/9."</ins>
						</p>
						<p>Most 1 percenters were born with socioeconomic advantages, which helps explain why the 1 percent is more likely than other Americans to have jobs, according to census data. They work longer hours, being three times more likely than the 99 percent
							to work more than 50 hours a week, and are more likely to be self-employel. Married 1 percenters are just as likely as other couples to have two incomes, but men are the big breadwinners, earning 75 percent of the money, compared with 64 percent
							of the income in other households.</p>
						<p>Though many of the wealthy lean toward the Republican Party, in interviews, 1 percenters expressed a broad range of views on how to fix the economy. They think that President Obama is ruining it, or that Republicans in Congress have gone off the
							deep end. They favor a flat tax, or they believe the rich should pay a higher marginal rate. Some cheered on Occupy Wall Street, saying it was about time, while others wished the protesters would just get a job or take a bath. Still others were
							philosophical &mdash; perhaps because they could afford to be &mdash; viewing the <a href="http://topics.nytimes.com/top/reference/timestopics/subjects/r/recession_and_depression/index.html?inline=nyt-classifier" title="More articles about the recession."
							class="meta-classifier">recession</a> as something that would pass, like so many previous ups and downs.</p>
						<p>
							<ins class="ins cts-2" data-cid="31" data-userid="chuck@mail.com" data-username="Chuck Noblet" data-time="1326765165952" title="Inserted by Chuck Noblet - 01/16/2012 8:52pm">Of the 1 percenters interviewed for this article, almost all &amp;mdash; conservatives and liberals alike &amp;mdash; said the wealthy could and should shoulder more of the country's financial burden, and almost all said they viewed the current
								system as unfair. But they may prefer facing cuts to their own benefits like <a href="http://topics.nytimes.com/top/reference/timestopics/subjects/s/social_security_us/index.html?inline=nyt-classifier" title="More articles about Social Security."
								class="meta-classifier">Social Security</a> than paying more taxes. In <a title="The survey, by the Russell Sage Foundation." href="http://www.russellsage.org/blog/r-mascarenhas/wealthiest-1-percent-and-common-good">one survey</a>
								of wealthy Chicago families, almost twice as many respondents said they would cut government spending as those who said they would cut spending and raise revenue.</ins>
						</p>
						<p>Even those who said the deck was stacked in their favor did not appreciate anti-rich rhetoric.</p>
						<p>"I don't mind paying a little bit more in taxes. I don't mind putting money to programs that help the poor," said Anthony J. Bonomo of Manhasset, N.Y., who runs a medical malpractice insurance company and is a Republican. But, he said, he did mind
							taking a hit for the country's woes. "If those people could camp out in that park all day, why aren't they out looking for a job? Why are they blaming others?"</p>
						<p>To many, 99 vs. 1 was an artificial distinction that overlooked hard work and moral character. "It shouldn't be relevant," said Mr. Katz , who said he both creates job and contributes to charitable causes. "I'm not hurting anyone. I'm helping a
							lot of people."</p>
						<p>
							<strong> The Enclave</strong>
						</p>
						<p>The placid sliver of Long Island that F. Scott Fitzgerald immortalized in "The Great Gatsby" as West Egg and East Egg seems almost to have shrugged off the recession.</p>
						<p>A stretch of northwest Nassau County that includes Great Neck, Manhasset and Port Washington, this area has the country's highest concentration of 1 percenters, and one of the lowest unemployment rates in the state. Houses in Port Washington are
							worth only 10 percent less than they were at their peak, according to the <a href="http://topics.nytimes.com/top/reference/timestopics/subjects/s/standard_poors_caseshiller_home_price_index/index.html?inline=nyt-classifier" title="More articles about the Case-Shiller Home Price Index."
							class="meta-classifier">Standard &amp; Poor's Case-Shiller Home Price Index</a>, a far smaller decline than in the rest of the country. Yearly sales at the Americana Manhasset, the upscale granite and glass shopping center, have already exceeded
							their prerecession high. Even in down times, the 1 percent has <a title="Tables 1 and 2 in a related study (PDF). " href="http://www.treasury.gov/resource-center/tax-policy/Documents/incomemobilitystudy03-08revise.pdf">staying power</a>, being
							far more likely than any other group to stay where they are rather than slip to lower rungs of the economic ladder.</p>
					</div>
				</div>
			</div>

		</div>
	</div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<!-- If smart quotes desired from pure javascript, use the lib, not the ice plugin. Otherwise, smartquotes is a pandoc option.	<script type="text/javascript" src='../lib/smartquotes.js'></script> -->
		<script type="text/javascript" src='../lib/rangy-1.3.0/rangy-core.js'></script>
		<script type="text/javascript" src='../src/polyfills.js'></script>
		<script type="text/javascript" src='../src/ice.js'></script>
		<script type="text/javascript" src='../src/dom.js'></script>
		<script type="text/javascript" src='../src/icePlugin.js'></script>
		<script type="text/javascript" src='../src/icePluginManager.js'></script>
		<script type="text/javascript" src='../src/bookmark.js'></script>
		<script type="text/javascript" src='../src/selection.js'></script>
		<script type="text/javascript" src='../src/plugins/IceAddTitlePlugin/IceAddTitlePlugin.js'></script>
		<script type="text/javascript" src='../src/plugins/IceCopyPastePlugin/IceCopyPastePlugin.js'></script>
		<script type="text/javascript" src='../src/plugins/IceEmdashPlugin/IceEmdashPlugin.js'></script>
		<script type="text/javascript" src='../src/plugins/IceCommentsPlugin/IceCommentsPlugin.js'></script>
		<script type="text/javascript" src='../src/plugins/IceCriticMarkupPlugin/IceCriticMarkupPlugin.js'></script>
		<script type="text/javascript">



			$(function() {
				text = document.getElementById('textbody');
				window.tracker = new ice.InlineChangeEditor({
					element: text,
					handleEvents: true,
					currentUser: {
						id: 'emily@mail.com',
						name: 'Emily somebody'
					},
					plugins: ['IceAddTitlePlugin', 'IceEmdashPlugin', 'IceCommentsPlugin', 'IceCriticMarkupPlugin', {
						name: 'IceCopyPastePlugin',
						settings: {
							pasteType: 'formattedClean',
							preserve: 'p,a[href],i,em,b,span,ul,ol,li,hr'
						}
					}]
				}).startTracking();
			});

			function setUser(el) {
				var name = $(el).find(':selected').data('username');
				var id = $(el).find(':selected').data('userid');
				tracker.setCurrentUser({
					id: id,
					name: name
				});
			}

			function insertSampleImage() {
				var range = tracker.getCurrentRange();
				if (!ice.dom.isChildOf(range.startContainer, text)) {
					return false;
				}
				var image = document.createElement('img');
				image.src = "http://graphics8.nytimes.com/images/2012/01/15/business/ONEPERCENT/ONEPERCENT-popup.jpg";
				image.width = 160;
				tracker.insert(image, range);
				text.focus();
			}

			$('#track_changes_off').click(function() {
				if ($(this).text() == 'Track Changes Off') {
					$(this).text('Track Changes On');
					tracker.disableChangeTracking();
				} else {
					$(this).text('Track Changes Off');
					tracker.enableChangeTracking();
				};
			});

			$('#show_hide_changes').click(function(el) {
				var body = document.getElementById('textbody');
				var button = $(el);
				if ($(body).hasClass('CT-hide')) {
					$(body).removeClass('CT-hide');
					$(this).text('Hide Changes');
				} else {
					$(body).addClass('CT-hide');
					$(this).text('Show Changes');
				}
			});
			$('#accept_all').click(function() {
      tracker.acceptAll();
			});
			$('#reject_all').click(function() {
				tracker.rejectAll();
			});
			//*Ideally these should look for paired changes, but that may be making too many assumptions.
			$('#accept_this').click(function(el) {
					tracker.acceptChange();
				});

			$('#reject_this').click(function() {
				tracker.rejectChange();
			});

			$('#highlight_this').click(function() {
					tracker.highlight();
					tracker.comment();
					tracker.disableChangeTracking();
					//$('mark').addClass('ice-avoid');
					//$('mark').attr('contentEditable', 'false');
					var range = tracker.getCurrentRange();
					var last = $(this).find('.mark');
					if(last.length){
						range.setStartAfter(last[0])
					}
					range.collapse(false);
					rangy.getSelection().setSingleRange(range);

			});

			$('#textbody').on('click', 'comment', function (event) {
				event.stopPropagation();
				if ( $(this).attr('data-userid') == tracker.currentUser.id ) {
					$(this).removeClass('ice-avoid');

} else {
	tracker.disableChangeTracking();
	$(this).attr('contentEditable', 'false');
		$(document).one( 'keydown', this, function(e) {

    if (e.which !== 0) {
			 e.preventDefault();

      //  alert("Charcter was typed. It was: " + String.fromCharCode(e.which));
				var range = tracker.getCurrentRange();
				var last = $(this).find('comment');

				//set the caret after the node for this range
				range.setStartAfter(last[0]);

				//apply this range to the selection object
				range.collapse(false);
				rangy.getSelection().setSingleRange(range);
				tracker.comment();
				last = $(this).next('comment');
				if(last.length){
				range.setStartAfter(last[0])
				}
				rangy.getSelection().setSingleRange(range);

    }
});

}
					 if ( $('comment > *').length > 0 ) {
				 $('comment > *').remove();
	 }
			});

			$('#textbody').on('click', 'mark', function (event) {
				event.stopPropagation();
			tracker.enableChangeTracking();
				if ( $('comment > *').length > 0 ) {
			$('comment > *').remove();
		}
			});

			$('#textbody').on('click', function (event) {
				event.stopPropagation();
				tracker.enableChangeTracking();
				if ( $('comment > *').length > 0 ) {
			$('comment > *').remove();
		}
			});

			$('#critic_markup').click(function() {
				if ($(this).text() == 'Turn Critic Markup Off') {
					$(this).text('Turn Critic Markup On');
					tracker.disableCriticMarkup();
				} else {
					$(this).text('Turn Critic Markup Off');
					tracker.enableCriticMarkup();
				};
			});

			$('#highlight_remove_this').click(function() {
				tracker.rejectHighlight();
			});
			$('#highlight_remove_all').click(function() {
				tracker.rejectAllHighlights();
			});
			$('#comment_this').click(function() {
				tracker.comment();
				tracker.disableChangeTracking();
			});
			$('#comment_delete').click(function() {
				tracker.rejectComment();

			});
			$('#comment_delete_all').click(function() {
				tracker.rejectAllCommentsHighlights();
			});

			// Once text is highlighted, it SHOULD NOT be changed unless you remove the highlight.
			//*Sane highlights and notes. Users should not be able to edit other's notes. When writing a note, changes shouldn't be tracked within it.
			//Currently using mark, but this is actually the function for comment.
			//ice-avoid should be added to all comments not created by the current user! if data-userid is currentUser ID removeclass ice-avoid. Else has the class.






		</script>

</body>

</html>
